<html>
<head>
<title>megasecond</title>
<script src="jquery.js"></script>
<link rel="stylesheet" href="ms.css" />
<script>
function floor(x) {
    // brilliantly returns "-0" for [0 .. 0.5) but whatevz.
    return (x - 0.5).toFixed(0);
}

function setupUpdates() {
    self.setInterval(function(){update_10ms()}, 100);
}
function update_1hr() {
}

function update_1s(n) {
    Ms = (n / 1e9);
    console.debug("Ms = " + Ms);
    Ks = floor(n / 1e6) % 1000;
    Ks = pad0(Ks, 3);
    Js = floor(n / 1e3) % 1000;
    Js = pad0(Js, 3);
    $('#megasecond.time').text(floor(Ms) + ".");
    $('#megasecond.subtime').text(Ks + "." + Js);
}

self.times = [];

function pad0(s,n) {
    s = "" + s;
    while (s.length < n) {
        s = "0" + s;
    }
    return s;
}

function update_10ms() {
    t0 = Date.now();
    n = Date.now();
    sec = n / 1000;
    $('#curtime.time').text((sec).toFixed(1));
    sec = floor(sec);
    if (self.lastsec != sec) {
        self.lastsec = sec;
        update_1s(n);
    }
    t1 = Date.now();
    e = (t1-t0);
    self.times.push(e);
    if (self.times.length > 100) self.times.shift();
    t = self.times.reduce(function(a,b) { return a+b }) / self.times.length;
    $('#fps').text('render took ' + t.toFixed(2) +
                   ' ms, occupancy ' + floor(t/10) + '% n=' +
                   self.times.length);
}
setupUpdates();
</script>
</head>
<body>

<div class="box" id="megasecond">
The current megasecond is <span id="megasecond" class="time"></span><span id="megasecond" class="subtime"></span><br/>
</div>
<div class="box" id="curtime">
Current UNIX time: <div id="curtime" class="time"></div><br/>
</div>
<div class="box" id="curtime">
Current UTC time: <div class="time">2012-09-18 06:26:52</div><br/>
</div>
<div class="box" id="curtime">
Next megasecond at: <div class="time" id="nextmegadate">2012-09-18 20:26:40</div> (14 hours from now)<br/>
</div>
<div class="box" id="curtime">
Previous megasecond at: <div class="time" id="lastmegadate">2012-09-07 06:40:00</div> (11 days ago)<br/>
</div>
<div class="box" id="curtime">
</div>
<div id='fps'></div>
</body></html>
